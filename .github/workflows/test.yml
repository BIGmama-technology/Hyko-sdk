name: Run pytest

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11.6
          cache: 'pip'

      - name: Install genbadge
        run:  pip install "genbadge[coverage]"

      - name: Run tests
        run:  make test      

      - name: Generate coverage badge
        run: genbadge coverage -i reports/coverage.xml -o reports/coverage-badge.svg

      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch

      - name: Commit
        uses: devops-infra/action-commit-push@master
        with:
          github_token: "${{ secrets.GITHUB_TOKEN }}"
          add_timestamp: true
          commit_prefix: "[AUTO]"
          commit_message: "update test coverage badge"
          force: false
          target_branch: ${{ steps.extract_branch.outputs.branch }}
  
