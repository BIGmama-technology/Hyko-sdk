name: Run pytest

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup ffmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11.6

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with: 
          version: 1.6.1
          virtualenvs-create: false

      - name: Install dependencies
        run: poetry install

      - name: Install genbadge
        run: poetry add "genbadge[coverage]"

      - name: Run tests
        run: |
          sudo mkdir /storage
          sudo pytest --cov=./hyko_sdk --cov-report=xml -W ignore::Warning
      
      - name: Generate coverage badge
        run: genbadge coverage -i coverage.xml -o reports/coverage/coverage-badge.svg

      - name: Commit
        uses: devops-infra/action-commit-push@master
        with:
          github_token: "${{ secrets.GITHUB_TOKEN }}"
          add_timestamp: true
          commit_prefix: "[AUTO]"
          commit_message: "update test coverage badge"
          force: false
          target_branch: update/version
  
